<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS Efficiency calculation - Register</title>
    <script src="Tailwind-OFFICIAL.js"></script>
    <style type="text/tailwindcss">
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 主卡片容器 */
        .card {
            @apply p-6 bg-white rounded-xl shadow-xl w-full;
        }
        /* 主按钮 */
        .btn-primary {
            @apply bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-xl transition-colors duration-200;
        }
        .btn-secondary {
            @apply bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-xl transition-colors duration-200;
        }
        .input-text {
            @apply w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .language-selector {
            @apply absolute top-4 right-4 sm:top-6 sm:right-6;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-8 relative">
    <!-- 语言选择器 -->
    <div class="language-selector">
        <select id="language-select" class="input-text text-sm sm:text-base">
            <option value="en">English</option>
            <option value="zh">中文</option>
            <option value="ja">日本語</option>
        </select>
    </div>

    <div class="flex flex-col items-stretch justify-center gap-8 w-full max-w-full lg:max-w-xl">
        <!-- 主卡片 -->
        <div id="register-card" class="card flex flex-col items-center gap-6">
            <h1 class="text-2xl font-bold text-center text-gray-800" data-i18n="register.title">New user register</h1>
            <p id="status-message" class="text-gray-600 text-center" data-i18n="register.preamble">Before registering an account, an email address must obtain authorization from the administrator.</p>
            <div class="w-full">
                <input type="text" id="input-username" class="input-text" placeholder="Username" data-i18n-placeholder="register.username">
            </div>
            <div class="w-full">
                <input type="email" id="input-email" class="input-text" placeholder="E-mail" data-i18n-placeholder="register.email">
            </div>
            <div class="w-full">
                <input type="tel" id="input-phone" class="input-text" placeholder="Phone Number" data-i18n-placeholder="register.phone">
            </div>
            <div class="w-full">
                <input type="password" id="input-password" class="input-text" placeholder="Password(Must remember)" data-i18n-placeholder="register.password">
            </div>
            <button id="btn-register" class="btn-primary w-full" data-i18n="register.registerBtn">Register</button>
            <a href="./index.html" class="w-full">
                <button class="btn-secondary w-full" data-i18n="register.returnBtn">Return to login</button>
            </a>
        </div>
    </div>

<script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.10.0/dist/av-min.js"></script>
<script>
    // 多语言文本映射
    const translations = {
        en: {
            "register.title": "New user register",
            "register.preamble": "Before registering an account, an email address must obtain authorization from the administrator.",
            "register.username": "Username",
            "register.email": "E-mail",
            "register.phone": "Phone Number",
            "register.password": "Password(Must remember)",
            "register.registerBtn": "Register",
            "register.returnBtn": "Return to login",
            "messages.allFieldsRequired": "All fields (username, email, phone number and password) are required!",
            "messages.invalidEmail": "Please enter a valid email address!",
            "messages.checkingAuthorization": "Verifying email authorization...",
            "messages.registering": "Registering...",
            "messages.registerSuccess": "Registration successful! Redirecting to dashboard...",
            "messages.registerFailed": "Registration failed: ",
            "messages.emailNotAuthorized": "Email is not authorized, please contact administrator.",
            "messages.authorizationFailed": "Failed to verify authorization: "
        },
        zh: {
            "register.title": "新用户注册",
            "register.preamble": "注册账户前，邮箱地址必须获得管理员授权。",
            "register.username": "用户名",
            "register.email": "电子邮箱",
            "register.phone": "手机号码",
            "register.password": "密码（请牢记）",
            "register.registerBtn": "注册",
            "register.returnBtn": "返回登录",
            "messages.allFieldsRequired": "所有字段（用户名、邮箱、手机号和密码）均为必填项！",
            "messages.invalidEmail": "请输入有效的邮箱地址！",
            "messages.checkingAuthorization": "正在验证邮箱授权...",
            "messages.registering": "正在注册...",
            "messages.registerSuccess": "注册成功！正在跳转到仪表盘...",
            "messages.registerFailed": "注册失败: ",
            "messages.emailNotAuthorized": "邮箱未获得授权，请联系管理员。",
            "messages.authorizationFailed": "验证授权失败: "
        },
        ja: {
            "register.title": "新規ユーザー登録",
            "register.preamble": "アカウントを登録する前に、メールアドレスは管理者からの御認可を取得している必要があります。",
            "register.username": "ユーザー名",
            "register.email": "メールアドレス",
            "register.phone": "携帯電話番号",
            "register.password": "パスワード（必ず記憶してください）",
            "register.registerBtn": "登録",
            "register.returnBtn": "ログイン画面に戻る",
            "messages.allFieldsRequired": "すべての項目（ユーザー名、メールアドレス、携帯電話番号、パスワード）は必須項目です！",
            "messages.invalidEmail": "有効なメールアドレスを入力してください！",
            "messages.checkingAuthorization": "メールアドレスの認可を確認中...",
            "messages.registering": "登録中...",
            "messages.registerSuccess": "登録が成功しました！ダッシュボードに移動中...",
            "messages.registerFailed": "登録に失敗しました: ",
            "messages.emailNotAuthorized": "メールアドレスは認可されていません。管理者に御連絡してください。",
            "messages.authorizationFailed": "認可の確認に失敗しました: "
        }
    };

    // 初始化语言设置
    function initLanguage() {
        // 从localStorage获取语言设置，如果没有则默认使用index.html的设置
        const savedLang = localStorage.getItem('preferredLanguage') || 'en';

        // 设置下拉菜单选中状态
        document.getElementById('language-select').value = savedLang;

        // 应用语言设置
        applyLanguage(savedLang);
    }

    // 应用语言设置
    function applyLanguage(lang) {
        // 更新所有带data-i18n属性的元素
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (translations[lang] && translations[lang][key]) {
                element.textContent = translations[lang][key];
            }
        });

        // 更新所有带data-i18n-placeholder属性的元素
        document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
            const key = element.getAttribute('data-i18n-placeholder');
            if (translations[lang] && translations[lang][key]) {
                element.placeholder = translations[lang][key];
            }
        });

        // 保存语言设置到localStorage
        localStorage.setItem('preferredLanguage', lang);
    }

    // 语言选择器事件监听
    document.getElementById('language-select').addEventListener('change', function () {
        applyLanguage(this.value);
    });

    // 初始化LeanCloud
    const AV = window.AV;
    AV.init({
        appId: "L5SNq7BVJ9m4jOr50MCp1iAd-gzGzoHsz",
        appKey: "6CDNvUG0zD9i7EI40nH9zNRv",
        serverURL: "https://l5snq7bv.lc-cn-n1-shared.com"
    });

    // 获取DOM元素
    const usernameInput = document.getElementById("input-username");
    const emailInput = document.getElementById("input-email");
    const phoneInput = document.getElementById("input-phone");
    const passwordInput = document.getElementById("input-password");
    const registerBtn = document.getElementById("btn-register");
    const statusMessage = document.getElementById("status-message");

    // 邮箱格式验证函数
    function isValidEmail(email) {
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return regex.test(email);
    }

    // 注册处理函数
    registerBtn.addEventListener('click', function () {
        const username = usernameInput.value.trim();
        const email = emailInput.value.trim();
        const phone = phoneInput.value.trim();
        const password = passwordInput.value;
        const currentLang = localStorage.getItem('preferredLanguage') || 'en';

        // 必填字段验证
        if (!username || !email || !phone || !password) {
            statusMessage.textContent = translations[currentLang]["messages.allFieldsRequired"];
            statusMessage.style.color = "red";
            return;
        }

        // 邮箱格式验证
        if (!isValidEmail(email)) {
            statusMessage.textContent = translations[currentLang]["messages.invalidEmail"];
            statusMessage.style.color = "red";
            return;
        }

        statusMessage.textContent = translations[currentLang]["messages.checkingAuthorization"];
        statusMessage.style.color = "gray";

        // 查询 AuthUsers 表，检查邮箱是否已授权
        const query = new AV.Query('AuthUsers');
        query.equalTo('email', email);
        query.find().then((results) => {
            if (results.length > 0) {
                // 邮箱已获得授权，继续注册
                statusMessage.textContent = translations[currentLang]["messages.registering"];
                statusMessage.style.color = "gray";

                const user = new AV.User();
                user.setUsername(username);
                user.setEmail(email);
                user.setPassword(password);
                user.set("Mima", password);
                user.setMobilePhoneNumber(phone);
                user.set("LIFTCV", "1");
                user.set("LIFTRAIL", "1");
                user.set("PSIBOB", "1");
                user.set("ALLPASS", "1");

                user.signUp()
                    .then(function (user) {
                        // 注册成功
                        statusMessage.textContent = translations[currentLang]["messages.registerSuccess"];
                        statusMessage.style.color = "green";
                        window.location.href = './dashboard.html';
                    })
                    .catch(function (error) {
                        // 注册失败
                        console.error(error);
                        statusMessage.textContent = translations[currentLang]["messages.registerFailed"] + error.code + " - " + error.message;
                        statusMessage.style.color = "red";
                    });
            } else {
                // 邮箱未获得授权
                statusMessage.textContent = translations[currentLang]["messages.emailNotAuthorized"];
                statusMessage.style.color = "red";
            }
        }).catch((error) => {
            console.error(error);
            statusMessage.textContent = translations[currentLang]["messages.authorizationFailed"] + error.message;
            statusMessage.style.color = "red";
        });
    });

    // 页面加载时初始化语言
    document.addEventListener('DOMContentLoaded', initLanguage);
</script>
</body>
</html>