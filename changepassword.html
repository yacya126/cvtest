<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS Efficiency calculation - Register</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 主卡片容器 */
        .card {
            @apply p-6 bg-white rounded-xl shadow-xl w-full;
        }
        /* 主按钮 */
        .btn-primary {
            @apply bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-xl transition-colors duration-200;
        }
        .btn-secondary {
            @apply bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-xl transition-colors duration-200;
        }
        .input-text {
            @apply w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .language-selector {
            @apply absolute top-4 right-4 sm:top-6 sm:right-6;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-8 relative">
    <!-- 语言选择器 -->
    <div class="language-selector">
        <select id="language-select" class="input-text text-sm sm:text-base">
            <option value="en">English</option>
            <option value="zh">中文</option>
            <option value="ja">日本語</option>
        </select>
    </div>

    <div class="flex flex-col items-stretch justify-center gap-8 w-full max-w-full lg:max-w-xl">
        <!-- 主卡片 -->
        <div id="register-card" class="card flex flex-col items-center gap-6">
            <h1 class="text-2xl font-bold text-center text-gray-800" data-i18n="register.title">Change Password</h1>
            <p id="status-message" class="text-gray-600 text-center" data-i18n="register.preamble">Before registering an account, an email address must obtain authorization from the administrator.</p>
            <div class="w-full">
                <input type="text" id="input-username" class="input-text" placeholder="Username" data-i18n-placeholder="register.username">
            </div>
            <div class="w-full">
                <input type="email" id="input-email" class="input-text" placeholder="E-mail" data-i18n-placeholder="register.email">
            </div>

            <div class="w-full">
                <input type="password" id="input-password" class="input-text" placeholder="Old Password" data-i18n-placeholder="register.password">
            </div>

            <div class="w-full">
                <input type="password" id="input-password-new" class="input-text" placeholder="New Password(Must remember)" data-i18n-placeholder="register.passwordnew">
            </div>

            <button id="btn-register" class="btn-primary w-full" data-i18n="register.registerBtn">Register</button>
            <button id="btn-return" class="btn-secondary w-full" data-i18n="register.returnBtn">Return</button>
        </div>
    </div>

<script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.10.0/dist/av-min.js"></script>
<script>
    // 多语言文本映射
    const translations = {
        en: {
            "register.title": "Change Password",
            "register.preamble": "Please enter your username, email, and old password to change your password.",
            "register.username": "Username",
            "register.email": "E-mail",

            "register.password": "Old Password",
            "register.passwordnew": "New Password(Must remember)",
            "register.registerBtn": "Register",
            "register.returnBtn": "Return to login",
            "messages.allFieldsRequired": "All fields (username, email, phone number and password) are required!",
            "messages.invalidEmail": "Please enter a valid email address!",
            "messages.checkingAuthorization": "Verifying email authorization...",
            "messages.registering": "Registering...",
            "messages.registerSuccess": "Registration successful! Redirecting to dashboard...",
            "messages.registerFailed": "Registration failed: ",
            "messages.emailNotAuthorized": "Email is not authorized, please contact administrator.",
            "messages.authorizationFailed": "Failed to verify authorization: ",
            "register.returnBtn": "Return",
            "changepassword.notlogin": "Error: Please log in first before modifying your password.",
            "changepassword.notmatch": "Error: The entered user information does not match the currently logged-in user. Password modification is not allowed.",
            "changepassword.userpassed": "User authentication passed. Preparing to change password...",
            "changepassword.nousers": "No matching user record found.",
            "changepassword.wrongpassword": "The entered old password is incorrect.",
            "changepassword.startchangepassword": "Old password verification passed. Starting to update password...",
            "changepassword.changesucceed": "Password modification succeeded!",
            "changepassword.newpassword": "New password：",
            "changepassword.inputpassword": "Old password：",
            "changepassword.failed201": "Password modification failed. Possible reason: The old password is incorrect (system password verification failed)",
            "changepassword.failed125": "Password modification failed. Possible reason: The new password does not meet security requirements (usually insufficient length)",
            "changepassword.failed403": "Password modification failed. Possible reason: Insufficient permissions (session expired or not logged in)",
            "changepassword.failed": "Password modification failed."
        },
        zh: {
            "register.title": "修改密码",
            "register.preamble": "请输入用户名、邮箱和旧密码来修改密码。",
            "register.username": "用户名",
            "register.email": "电子邮箱",

            "register.password": "旧密码",
            "register.passwordnew": "新密码（请牢记）",
            "register.registerBtn": "注册",
            "register.returnBtn": "返回登录",
            "messages.allFieldsRequired": "所有字段（用户名、邮箱、手机号和密码）均为必填项！",
            "messages.invalidEmail": "请输入有效的邮箱地址！",
            "messages.checkingAuthorization": "正在验证邮箱授权...",
            "messages.registering": "正在注册...",
            "messages.registerSuccess": "注册成功！正在跳转到仪表盘...",
            "messages.registerFailed": "注册失败: ",
            "messages.emailNotAuthorized": "邮箱未获得授权，请联系管理员。",
            "messages.authorizationFailed": "验证授权失败: ",
            "register.returnBtn": "返回",
            "changepassword.notlogin": "错误：请先登录再进行密码修改操作",
            "changepassword.notmatch": "错误：输入的用户信息与当前登录用户不匹配，无法修改密码",
            "changepassword.userpassed": "用户身份验证通过，准备修改密码...",
            "changepassword.nousers": "未找到匹配的用户记录",
            "changepassword.wrongpassword": "输入的旧密码不正确。",
            "changepassword.startchangepassword": "旧密码验证通过，开始更新密码...",
            "changepassword.changesucceed": "密码修改已成功！",
            "changepassword.newpassword": "新密码：",
            "changepassword.inputpassword": "旧密码：",
            "changepassword.failed201": "密码修改失败，可能原因：旧密码不正确（系统密码验证失败）",
            "changepassword.failed125": "密码修改失败，可能原因：新密码不符合安全要求（通常是长度不足）",
            "changepassword.failed403": "密码修改失败，可能原因：权限不足（会话过期或未登录）",
            "changepassword.failed": "密码修改失败！"
        },
        ja: {
            "register.title": "パスワードを変更する",
            "register.preamble": "パスワードを変更するために、ユーザー名、メールアドレス、旧パスワードを入力してください。",
            "register.username": "ユーザー名",
            "register.email": "メールアドレス",

            "register.password": "旧パスワード",
            "register.passwordnew": "新パスワード（必ず記憶してください）",
            "register.registerBtn": "登録",
            "register.returnBtn": "ログイン画面に戻る",
            "messages.allFieldsRequired": "すべての項目（ユーザー名、メールアドレス、携帯電話番号、パスワード）は必須項目です！",
            "messages.invalidEmail": "有効なメールアドレスを入力してください！",
            "messages.checkingAuthorization": "メールアドレスの認可を確認中...",
            "messages.registering": "登録中...",
            "messages.registerSuccess": "登録が成功しました！ダッシュボードに移動中...",
            "messages.registerFailed": "登録に失敗しました: ",
            "messages.emailNotAuthorized": "メールアドレスは認可されていません。管理者に御連絡してください。",
            "messages.authorizationFailed": "認可の確認に失敗しました: ",
            "register.returnBtn": "戻る",
            "changepassword.notlogin": "エラー：パスワードを変更する前に、先にログインしてください。",
            "changepassword.notmatch": "エラー：入力したユーザー情報が現在ログインしているユーザーと一致しません。パスワードの変更はできません。",
            "changepassword.userpassed": "ユーザー認証が完了しました。パスワードの変更を準備中です...",
            "changepassword.nousers": "一致するユーザーレコードが見つかりませんでした。",
            "changepassword.wrongpassword": "入力した旧パスワードが正しくありません。",
            "changepassword.startchangepassword": "旧パスワードの認証に合格しました。パスワードの更新を開始します...",
            "changepassword.changesucceed": "パスワードの変更が成功しました",
            "changepassword.newpassword": "新パスワード：",
            "changepassword.inputpassword": "旧パスワード：",
            "changepassword.failed201": "パスワードの変更に失敗しました。原因の可能性：旧パスワードが正しくない（システムのパスワード認証に失敗）",
            "changepassword.failed125": "パスワードの変更に失敗しました。原因の可能性：新しいパスワードがセキュリティ要件を満たしていない（通常は文字数が不足している）",
            "changepassword.failed403": "パスワードの変更に失敗しました。原因の可能性：アクセス権が不足している（セッションの有効期限切れまたは未ログイン）",
            "changepassword.failed": "パスワードの変更に失敗しました。"
        }
    };

    // 初始化语言设置
    function initLanguage() {
        // 从localStorage获取语言设置，如果没有则默认使用index.html的设置
        const savedLang = localStorage.getItem('preferredLanguage') || 'en';

        // 设置下拉菜单选中状态
        document.getElementById('language-select').value = savedLang;

        // 应用语言设置
        applyLanguage(savedLang);
    }

    // 应用语言设置
    function applyLanguage(lang) {
        // 更新所有带data-i18n属性的元素
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (translations[lang] && translations[lang][key]) {
                element.textContent = translations[lang][key];
            }
        });

        // 更新所有带data-i18n-placeholder属性的元素
        document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
            const key = element.getAttribute('data-i18n-placeholder');
            if (translations[lang] && translations[lang][key]) {
                element.placeholder = translations[lang][key];
            }
        });

        // 保存语言设置到localStorage
        localStorage.setItem('preferredLanguage', lang);
    }

    // 用户验证函数
    async function validateUser(inputEmail, inputmima, inputusername) {
        const userQuery = new AV.Query('_User');

        try {
            // 首先尝试用email匹配
            userQuery.equalTo('email', inputEmail);
            const emailMatches = await userQuery.find();

            if (emailMatches.length > 0) {
                // 用email找到匹配对象
                const user = emailMatches[0];
                const storedmima = user.get('Mima');
                const storedusername = user.get('username');

                console.log('通过email找到匹配对象:', user);

                // 验证mima和username
                if (storedmima === inputmima && storedusername === inputusername) {
                    console.log('验证成功：email、mima和username全部匹配');
                    return true;
                } else {
                    console.log('验证失败：找到对象但信息不匹配');
                    console.log(`存储的mima: ${storedmima}, 输入的mima: ${inputmima}`);
                    console.log(`存储的username: ${storedusername}, 输入的username: ${inputusername}`);
                    return false;
                }
            } else {
                // email未匹配到，尝试用username匹配
                const usernameQuery = new AV.Query('_User');
                usernameQuery.equalTo('username', inputusername);
                const usernameMatches = await usernameQuery.find();

                if (usernameMatches.length > 0) {
                    console.log(`通过username找到${usernameMatches.length}个匹配对象，尝试进一步验证email`);

                    // 从username匹配结果中查找email也匹配的对象
                    const exactMatch = usernameMatches.find(user => user.get('email') === inputEmail);

                    if (exactMatch) {
                        // 验证mima
                        const storedmima = exactMatch.get('Mima');
                        console.log('通过username和email找到匹配对象:', exactMatch);

                        if (storedmima === inputmima) {
                            console.log('验证成功：email、mima和username全部匹配');
                            return true;
                        } else {
                            console.log('验证失败：mima不匹配');
                            console.log(`存储的mima: ${storedmima}, 输入的mima: ${inputmima}`);
                            return false;
                        }
                    } else {
                        console.log('验证失败：在username匹配结果中未找到对应email的对象');
                        console.log('username匹配到的对象:', usernameMatches);
                        return false;
                    }
                } else {
                    // 未找到任何匹配对象
                    console.log('未找到匹配的用户对象');
                    return false;
                }
            }
        } catch (error) {
            console.error('查询过程出错:', error);
            return false;
        }
    }

    // 语言选择器事件监听
    document.getElementById('language-select').addEventListener('change', function () {
        applyLanguage(this.value);
    });

    // 初始化LeanCloud
    const AV = window.AV;
    AV.init({
        appId: "L5SNq7BVJ9m4jOr50MCp1iAd-gzGzoHsz",
        appKey: "6CDNvUG0zD9i7EI40nH9zNRv",
        serverURL: "https://l5snq7bv.lc-cn-n1-shared.com"
    });

    // 获取DOM元素
    const usernameInput = document.getElementById("input-username");
    const emailInput = document.getElementById("input-email");
    const phoneInput = document.getElementById("input-phone");
    const passwordInput = document.getElementById("input-password");
    const newpasswordInput = document.getElementById("input-password-new");
    const registerBtn = document.getElementById("btn-register");
    const statusMessage = document.getElementById("status-message");
    const returnBtn = document.getElementById("btn-return");

    // 邮箱格式验证函数
    function isValidEmail(email) {
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return regex.test(email);
    }

    // 注册处理函数
    registerBtn.addEventListener('click', function () {
        // 从localStorage获取语言设置，如果没有则默认使用index.html的设置
        const currentLang = localStorage.getItem('preferredLanguage') || 'en';
        // 用户输入的信息（实际应用中替换为表单输入）
        const inputUsername = usernameInput.value.trim();    // 输入的用户名
        const inputPassword = passwordInput.value.trim(); // 输入的旧密码（用于验证）
        const newPassword = newpasswordInput.value.trim();   // 要设置的新密码
        const inputEmail = emailInput.value.trim(); // 输入的邮箱

        // 获取当前登录用户
        const currentUser = AV.User.current();

        // 检查用户是否已登录
        if (!currentUser) {
            console.error("错误：请先登录再进行密码修改操作");
            statusMessage.textContent = translations[currentLang]["changepassword.notlogin"];
            statusMessage.style.color = "red";
        } else {
            // 1. 验证输入的用户是否为当前登录用户
            const currentUsername = currentUser.get('username');
            const currentEmail = currentUser.get('email');
            if ((currentUsername !== inputUsername) || (currentEmail !== inputEmail)) {
                
                console.log(`当前登录用户：${currentUsername} (${currentEmail})`);
                console.log(`输入的用户：${inputUsername} (${inputEmail})`);
                statusMessage.textContent = translations[currentLang]["changepassword.notmatch"] + `CurrentUsers：${currentUsername} (${currentEmail}) ，` + `InputUsers：${inputUsername} (${inputEmail})`;
                statusMessage.style.color = "red";
                console.error("错误：输入的用户信息与当前登录用户不匹配，无法修改密码");
            } else {
                // 2. 验证通过，执行密码修改
                console.log("用户身份验证通过，准备修改密码...");
                statusMessage.textContent = translations[currentLang]["changepassword.userpassed"];
                statusMessage.style.color = "green";
                // 3. 先验证旧密码是否正确（通过查询用户记录）
                const userQuery = new AV.Query('_User');
                userQuery.equalTo('username', inputUsername);
                userQuery.equalTo('email', inputEmail);

                userQuery.find()
                    .then(users => {
                        if (users.length === 0) {
                            
                            statusMessage.textContent = translations[currentLang]["changepassword.nousers"];
                            statusMessage.style.color = "red";
                            throw new Error(translations[currentLang]["changepassword.nousers"]);
                        }

                        const targetUser = users[0];
                        // 验证明文管理密码Mima是否匹配输入的旧密码
                        if (targetUser.get('Mima') !== inputPassword) {
                            
                            statusMessage.textContent = translations[currentLang]["changepassword.wrongpassword"];
                            statusMessage.style.color = "red";
                            throw new Error(translations[currentLang]["changepassword.wrongpassword"]);
                        }

                        console.log("旧密码验证通过，开始更新密码...");
                        statusMessage.textContent = translations[currentLang]["changepassword.startchangepassword"];
                        statusMessage.style.color = "green";
                        // 4. 先更新加密的password字段
                        return currentUser.updatePassword(inputPassword, newPassword)
                            .then(() => {
                                // 5. 再更新明文管理字段Mima
                                currentUser.set('Mima', newPassword);
                                return currentUser.save();
                            });
                    })
                    .then(() => {
                        // 6. 所有更新完成
                        console.log("密码修改成功！");
                        console.log("已同步更新：");
                        console.log("- 系统加密密码（password字段）");
                        console.log("- 后台管理明文密码（Mima字段）");
                        console.log(`新密码：${newPassword}`);
                        statusMessage.textContent =
                            translations[currentLang]["changepassword.changesucceed"] +
                            translations[currentLang]["changepassword.newpassword"] +
                            newPassword +
                            translations[currentLang]["changepassword.inputpassword"] +
                            inputPassword;
                        statusMessage.style.color = "green";
                    })
                    .catch(error => {
                        // 错误处理
                        statusMessage.textContent = translations[currentLang]["changepassword.failed"]+error.message;
                        statusMessage.style.color = "red";
                        console.error("密码修改失败：", error.message);
                        if (error.code === 201) {
                            console.log("可能原因：旧密码不正确（系统密码验证失败）");
                            statusMessage.textContent = translations[currentLang]["changepassword.failed201"];
                            statusMessage.style.color = "red";
                        } else if (error.code === 125) {
                            console.log("可能原因：新密码不符合安全要求（通常是长度不足）");
                            statusMessage.textContent = translations[currentLang]["changepassword.failed125"];
                            statusMessage.style.color = "red";
                        } else if (error.code === 403) {
                            console.log("可能原因：权限不足（会话过期或未登录）");
                            statusMessage.textContent = translations[currentLang]["changepassword.failed403"];
                            statusMessage.style.color = "red";
                        }
                    });
            }
        }
    });

    // 返回登录按钮事件
    returnBtn.addEventListener('click', function () {
        window.location.href = 'dashboard.html';
    });

    // 页面加载时初始化语言
    document.addEventListener('DOMContentLoaded', initLanguage);

    // 页面加载时显示用户名
    window.onload = () => {
        const statusMessage = document.getElementById("status-message");
        const currentUser = AV.User.current();
        let word = statusMessage.textContent;
        word = currentUser.get("username") + ", " + word;
        statusMessage.textContent = word;
    }
</script>
</body>
</html>